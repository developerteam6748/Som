<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FreeChat - 100% Free Messaging & Video Calls</title>
    <script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.0/socket.io.min.js"></script>
    <style>
        :root {
            --primary: #25D366;
            --primary-dark: #128C7E;
            --secondary: #34B7F1;
            --danger: #FF3B30;
            --light: #F0F2F5;
            --dark: #3B4A54;
            --white: #FFFFFF;
            --shadow: 0 2px 5px rgba(0,0,0,0.1);
            --radius: 12px;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            touch-action: manipulation;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            overflow: hidden;
        }
        
        .app-container {
            max-width: 500px;
            margin: 0 auto;
            height: 100vh;
            background: var(--white);
            position: relative;
            overflow: hidden;
            box-shadow: 0 0 20px rgba(0,0,0,0.2);
        }
        
        /* Header Styles */
        .header {
            background: linear-gradient(135deg, var(--primary-dark), var(--primary));
            color: white;
            padding: 15px;
            text-align: center;
            position: relative;
            z-index: 100;
            box-shadow: var(--shadow);
        }
        
        .header h1 {
            font-size: 22px;
            font-weight: 700;
        }
        
        .tagline {
            font-size: 13px;
            opacity: 0.9;
            margin-top: 3px;
        }
        
        .badge {
            background: var(--secondary);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: bold;
            margin-left: 5px;
        }
        
        /* Status Indicator */
        .status-indicator {
            font-size: 12px;
            margin-top: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #FF3B30;
        }
        
        .status-dot.connected {
            background: #4CD964;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        /* Pages */
        .page {
            display: none;
            height: calc(100vh - 70px);
            padding: 10px;
            overflow-y: auto;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        .page.active {
            display: block;
        }
        
        /* Home Page */
        .home-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 20px;
        }
        
        .feature-card {
            background: var(--white);
            border-radius: var(--radius);
            padding: 20px 15px;
            text-align: center;
            box-shadow: var(--shadow);
            border: 2px solid var(--light);
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .feature-card:hover {
            transform: translateY(-5px);
            border-color: var(--primary);
        }
        
        .feature-card .icon {
            font-size: 30px;
            margin-bottom: 10px;
        }
        
        .feature-card h3 {
            font-size: 16px;
            margin-bottom: 5px;
            color: var(--dark);
        }
        
        .feature-card p {
            font-size: 12px;
            color: #666;
        }
        
        /* Chat List Page */
        .contact-list {
            margin-top: 10px;
        }
        
        .contact-item {
            display: flex;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid var(--light);
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .contact-item:hover {
            background: var(--light);
        }
        
        .contact-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
            font-weight: bold;
            margin-right: 15px;
        }
        
        .contact-info h4 {
            font-size: 16px;
            color: var(--dark);
        }
        
        .contact-info p {
            font-size: 13px;
            color: #666;
            margin-top: 3px;
        }
        
        .online-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--primary);
            margin-left: auto;
        }
        
        /* Chat Page */
        .chat-header {
            display: flex;
            align-items: center;
            padding: 10px;
            background: var(--light);
            border-bottom: 1px solid #ddd;
        }
        
        .back-btn {
            background: none;
            border: none;
            font-size: 20px;
            margin-right: 15px;
            cursor: pointer;
            color: var(--dark);
        }
        
        .messages-container {
            height: calc(100vh - 180px);
            overflow-y: auto;
            padding: 15px;
            background: #ECE5DD url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" opacity="0.05"><path d="M50,0 C22.4,0 0,22.4 0,50 C0,77.6 22.4,100 50,100 C77.6,100 100,77.6 100,50 C100,22.4 77.6,0 50,0 Z M50,90 C27.9,90 10,72.1 10,50 C10,27.9 27.9,10 50,10 C72.1,10 90,27.9 90,50 C90,72.1 72.1,90 50,90 Z"/></svg>');
        }
        
        .message {
            max-width: 75%;
            padding: 12px 15px;
            margin: 8px 0;
            border-radius: 18px;
            position: relative;
            word-wrap: break-word;
            animation: messageAppear 0.3s ease;
        }
        
        @keyframes messageAppear {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .message.incoming {
            background: var(--white);
            border-top-left-radius: 5px;
            margin-right: auto;
        }
        
        .message.outgoing {
            background: #DCF8C6;
            border-top-right-radius: 5px;
            margin-left: auto;
        }
        
        .message-time {
            font-size: 11px;
            color: #666;
            text-align: right;
            margin-top: 5px;
        }
        
        .typing-indicator {
            display: inline-flex;
            padding: 10px 15px;
            background: var(--white);
            border-radius: 18px;
            border-top-left-radius: 5px;
        }
        
        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #999;
            margin: 0 2px;
            animation: typing 1.4s infinite;
        }
        
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        
        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-5px); }
        }
        
        /* Input Area */
        .input-area {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--light);
            padding: 10px;
            border-top: 1px solid #ddd;
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .message-input {
            flex: 1;
            padding: 12px 15px;
            border: none;
            border-radius: 25px;
            background: var(--white);
            font-size: 15px;
        }
        
        .send-btn {
            background: var(--primary);
            color: white;
            border: none;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.3s;
        }
        
        .send-btn:hover {
            background: var(--primary-dark);
        }
        
        .action-btn {
            background: none;
            border: none;
            font-size: 24px;
            color: var(--primary);
            cursor: pointer;
            padding: 5px;
        }
        
        /* Call Page */
        .call-container {
            height: calc(100vh - 70px);
            background: #000;
            position: relative;
        }
        
        .video-container {
            width: 100%;
            height: 100%;
            position: relative;
        }
        
        .local-video {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 120px;
            height: 160px;
            border-radius: 10px;
            border: 2px solid white;
            z-index: 10;
        }
        
        .remote-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .call-controls {
            position: absolute;
            bottom: 50px;
            left: 0;
            right: 0;
            display: flex;
            justify-content: center;
            gap: 30px;
        }
        
        .call-btn {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        
        .call-btn.accept {
            background: #4CD964;
            color: white;
        }
        
        .call-btn.decline {
            background: var(--danger);
            color: white;
        }
        
        .call-btn.end {
            background: var(--danger);
            color: white;
        }
        
        .call-btn.mute {
            background: #8E8E93;
            color: white;
        }
        
        /* QR Code Page */
        .qr-container {
            text-align: center;
            padding: 20px;
        }
        
        .qr-code {
            width: 200px;
            height: 200px;
            margin: 20px auto;
            padding: 10px;
            background: white;
            border-radius: 10px;
        }
        
        /* Buttons */
        .btn {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin: 10px 0;
            box-shadow: var(--shadow);
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .btn-secondary {
            background: var(--secondary);
        }
        
        /* Form Elements */
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--dark);
            font-weight: 500;
        }
        
        .form-control {
            width: 100%;
            padding: 15px;
            border: 2px solid var(--light);
            border-radius: var(--radius);
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--primary);
            color: white;
            padding: 15px 20px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            z-index: 1000;
            animation: slideInRight 0.3s ease;
            display: none;
        }
        
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        /* Loading Spinner */
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--light);
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Responsive */
        @media (max-width: 480px) {
            .app-container {
                border-radius: 0;
            }
            
            .home-grid {
                grid-template-columns: 1fr;
            }
            
            .message {
                max-width: 85%;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <div class="header">
            <h1>FreeChat <span class="badge">100% FREE</span></h1>
            <div class="tagline">No Ads ‚Ä¢ No Subscription ‚Ä¢ No Limits</div>
            <div class="status-indicator">
                <div class="status-dot" id="statusDot"></div>
                <span id="connectionStatus">Connecting...</span>
            </div>
        </div>
        
        <!-- Notification -->
        <div class="notification" id="notification"></div>
        
        <!-- Pages -->
        <div class="page active" id="homePage">
            <h2 style="text-align: center; margin: 20px 0; color: var(--dark);">Choose an Option</h2>
            
            <div class="home-grid">
                <div class="feature-card" onclick="showPage('contactsPage')">
                    <div class="icon">üí¨</div>
                    <h3>Text Message</h3>
                    <p>Send messages to anyone, even offline</p>
                </div>
                
                <div class="feature-card" onclick="startNewCall()">
                    <div class="icon">üìû</div>
                    <h3>Video Call</h3>
                    <p>Free HD video calls - 0 cost!</p>
                </div>
                
                <div class="feature-card" onclick="showPage('qrPage')">
                    <div class="icon">üë•</div>
                    <h3>Add Friend</h3>
                    <p>Share your unique ID or scan QR</p>
                </div>
                
                <div class="feature-card" onclick="showPage('contactsPage')">
                    <div class="icon">üì±</div>
                    <h3>Voice Call</h3>
                    <p>Crystal clear voice calls</p>
                </div>
            </div>
            
            <div style="margin-top: 30px; padding: 20px; background: var(--light); border-radius: var(--radius);">
                <h4 style="margin-bottom: 10px; color: var(--dark);">Why FreeChat?</h4>
                <ul style="font-size: 13px; color: #666; line-height: 1.6;">
                    <li>‚úÖ 100% Free forever - No hidden costs</li>
                    <li>‚úÖ Works offline - Messages deliver when online</li>
                    <li>‚úÖ No phone number needed</li>
                    <li>‚úÖ End-to-end encrypted</li>
                    <li>‚úÖ No data collection or tracking</li>
                </ul>
            </div>
        </div>
        
        <!-- Contacts Page -->
        <div class="page" id="contactsPage">
            <div class="chat-header">
                <button class="back-btn" onclick="showPage('homePage')">‚Üê</button>
                <div style="flex: 1;">
                    <h3 style="color: var(--dark);">Contacts</h3>
                </div>
            </div>
            
            <div class="contact-list">
                <!-- Contacts will be loaded here -->
                <div id="contactsList">
                    <div style="text-align: center; padding: 40px 20px; color: #666;">
                        <div style="font-size: 48px; margin-bottom: 20px;">üë•</div>
                        <p>No contacts yet</p>
                        <p style="font-size: 13px; margin-top: 10px;">Add friends using their ID to start chatting</p>
                        <button class="btn" onclick="showPage('qrPage')" style="margin-top: 20px;">Add Contact</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Chat Page -->
        <div class="page" id="chatPage">
            <div class="chat-header">
                <button class="back-btn" onclick="showPage('contactsPage')">‚Üê</button>
                <div style="flex: 1;">
                    <h3 id="chatWithName" style="color: var(--dark);">Chat</h3>
                    <p id="chatStatus" style="font-size: 12px; color: #666;">Online</p>
                </div>
                <button class="action-btn" onclick="startVideoCall()" title="Video Call">üìπ</button>
            </div>
            
            <div class="messages-container" id="messagesContainer">
                <!-- Messages will appear here -->
            </div>
            
            <div class="input-area">
                <input type="text" 
                       class="message-input" 
                       id="messageInput" 
                       placeholder="Type a message..."
                       onkeypress="if(event.key === 'Enter') sendMessage()">
                <button class="send-btn" onclick="sendMessage()">‚Üë</button>
            </div>
        </div>
        
        <!-- Add Friend / QR Page -->
        <div class="page" id="qrPage">
            <div class="chat-header">
                <button class="back-btn" onclick="showPage('homePage')">‚Üê</button>
                <h3 style="color: var(--dark);">Add Friend</h3>
            </div>
            
            <div class="qr-container">
                <div style="text-align: center; padding: 20px;">
                    <h4 style="margin-bottom: 15px; color: var(--dark);">Your Unique ID</h4>
                    <div style="background: var(--light); padding: 15px; border-radius: var(--radius); margin: 20px 0; font-family: monospace; font-size: 18px;">
                        <span id="userIdDisplay">Loading...</span>
                    </div>
                    
                    <button class="btn" onclick="copyUserId()">üìã Copy ID</button>
                    
                    <div style="margin-top: 30px;">
                        <h4 style="margin-bottom: 15px; color: var(--dark);">Add Friend by ID</h4>
                        <input type="text" 
                               class="form-control" 
                               id="friendIdInput" 
                               placeholder="Enter friend's ID">
                        <button class="btn" onclick="addFriend()" style="margin-top: 15px;">Add Contact</button>
                    </div>
                    
                    <div style="margin-top: 40px; padding: 20px; background: var(--light); border-radius: var(--radius);">
                        <h4 style="margin-bottom: 10px; color: var(--dark);">How it works</h4>
                        <ol style="text-align: left; font-size: 13px; color: #666; line-height: 1.8; padding-left: 20px;">
                            <li>Share your ID with friends</li>
                            <li>They add you using your ID</li>
                            <li>Start chatting immediately</li>
                            <li>Make free video calls anytime</li>
                        </ol>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Video Call Page -->
        <div class="page" id="callPage">
            <div class="call-container">
                <div class="video-container">
                    <video id="remoteVideo" class="remote-video" autoplay playsinline></video>
                    <video id="localVideo" class="local-video" autoplay playsinline muted></video>
                </div>
                
                <div class="call-controls">
                    <button class="call-btn mute" onclick="toggleMute()" id="muteBtn">
                        üîá
                    </button>
                    <button class="call-btn end" onclick="endCall()">
                        üìû
                    </button>
                    <button class="call-btn" onclick="toggleVideo()" id="videoBtn">
                        üìπ
                    </button>
                </div>
                
                <div id="callInfo" style="position: absolute; top: 20px; left: 20px; color: white; background: rgba(0,0,0,0.5); padding: 10px 15px; border-radius: var(--radius);">
                    <div id="callTimer">00:00</div>
                    <div id="callStatus">Connecting...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global Variables
        let peer = null;
        let userId = null;
        let currentConnection = null;
        let currentChatId = null;
        let connections = {};
        let offlineMessages = {};
        let mediaStream = null;
        let callStartTime = null;
        let callTimerInterval = null;
        
        // DOM Elements
        const statusDot = document.getElementById('statusDot');
        const connectionStatus = document.getElementById('connectionStatus');
        const userIdDisplay = document.getElementById('userIdDisplay');
        const notification = document.getElementById('notification');
        
        // Initialize PeerJS
        function initPeer() {
            // Generate a memorable user ID
            const adjectives = ['Cool', 'Fast', 'Smart', 'Happy', 'Funny', 'Clever', 'Brave', 'Calm', 'Kind', 'Wise'];
            const animals = ['Tiger', 'Lion', 'Eagle', 'Bear', 'Wolf', 'Fox', 'Hawk', 'Shark', 'Dolphin', 'Panda'];
            const randomNum = Math.floor(1000 + Math.random() * 9000);
            const randomId = `${adjectives[Math.floor(Math.random() * adjectives.length)]}${animals[Math.floor(Math.random() * animals.length)]}${randomNum}`;
            
            peer = new Peer(randomId, {
                host: '0.peerjs.com',
                port: 443,
                path: '/',
                pingInterval: 5000
            });
            
            peer.on('open', (id) => {
                userId = id;
                userIdDisplay.textContent = id;
                updateStatus('connected', 'Online');
                showNotification('Connected to FreeChat network!', 'success');
                
                // Load saved contacts and messages
                loadContacts();
                loadOfflineMessages();
            });
            
            peer.on('error', (err) => {
                console.error('PeerJS error:', err);
                updateStatus('error', 'Connection error');
                
                // Try to reconnect
                setTimeout(initPeer, 3000);
            });
            
            // Listen for incoming connections
            peer.on('connection', (conn) => {
                setupConnection(conn);
                showNotification(`New connection from ${conn.peer}`, 'info');
            });
            
            // Listen for incoming calls
            peer.on('call', (call) => {
                showNotification(`Incoming video call from ${call.peer}`, 'info');
                handleIncomingCall(call);
            });
        }
        
        // Update connection status UI
        function updateStatus(status, text) {
            statusDot.className = 'status-dot ' + status;
            connectionStatus.textContent = text;
            
            if (status === 'connected') {
                statusDot.classList.add('connected');
            }
        }
        
        // Show notification
        function showNotification(message, type = 'info') {
            notification.textContent = message;
            notification.style.display = 'block';
            notification.style.background = type === 'success' ? '#4CD964' : 
                                          type === 'error' ? '#FF3B30' : '#007AFF';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }
        
        // Page Navigation
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            document.getElementById(pageId).classList.add('active');
            
            // Special handling for pages
            if (pageId === 'contactsPage') {
                renderContacts();
            }
        }
        
        // Copy User ID
        function copyUserId() {
            navigator.clipboard.writeText(userId).then(() => {
                showNotification('User ID copied to clipboard!', 'success');
            });
        }
        
        // Add Friend
        function addFriend() {
            const friendId = document.getElementById('friendIdInput').value.trim();
            
            if (!friendId) {
                showNotification('Please enter a friend ID', 'error');
                return;
            }
            
            if (friendId === userId) {
                showNotification("You can't add yourself", 'error');
                return;
            }
            
            // Save contact
            const contacts = JSON.parse(localStorage.getItem('freechat_contacts') || '[]');
            if (!contacts.includes(friendId)) {
                contacts.push(friendId);
                localStorage.setItem('freechat_contacts', JSON.stringify(contacts));
            }
            
            // Try to connect
            const conn = peer.connect(friendId);
            setupConnection(conn);
            
            document.getElementById('friendIdInput').value = '';
            showNotification('Friend added successfully!', 'success');
            showPage('contactsPage');
        }
        
        // Setup connection
        function setupConnection(conn) {
            conn.on('open', () => {
                connections[conn.peer] = conn;
                showNotification(`Connected to ${conn.peer}`, 'success');
                
                // Send any pending offline messages
                sendPendingOfflineMessages(conn.peer);
            });
            
            conn.on('data', (data) => {
                handleIncomingData(conn.peer, data);
            });
            
            conn.on('close', () => {
                delete connections[conn.peer];
                showNotification(`Disconnected from ${conn.peer}`, 'error');
            });
            
            conn.on('error', (err) => {
                console.error('Connection error:', err);
            });
        }
        
        // Handle incoming data
        function handleIncomingData(senderId, data) {
            if (data.type === 'message') {
                saveMessage(senderId, data.message, false, data.timestamp);
                
                if (currentChatId === senderId) {
                    renderMessage(senderId, data.message, false, data.timestamp);
                } else {
                    showNotification(`New message from ${senderId}`, 'info');
                }
                
                // Send delivery receipt
                if (connections[senderId]) {
                    connections[senderId].send({
                        type: 'delivery_receipt',
                        messageId: data.messageId
                    });
                }
            } else if (data.type === 'delivery_receipt') {
                // Mark message as delivered
                markMessageDelivered(data.messageId);
            } else if (data.type === 'typing') {
                showTypingIndicator(senderId, data.isTyping);
            }
        }
        
        // Start chat with a contact
        function startChat(contactId) {
            currentChatId = contactId;
            document.getElementById('chatWithName').textContent = contactId;
            
            // Update status
            const isOnline = connections[contactId] ? 'Online' : 'Offline';
            document.getElementById('chatStatus').textContent = isOnline;
            
            showPage('chatPage');
            renderChatMessages(contactId);
        }
        
        // Send message
        function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            const timestamp = new Date().toISOString();
            const messageId = Date.now().toString();
            
            // Save message locally
            saveMessage(currentChatId, message, true, timestamp, messageId);
            renderMessage(currentChatId, message, true, timestamp, messageId);
            
            input.value = '';
            
            // Send to recipient if online
            if (connections[currentChatId]) {
                connections[currentChatId].send({
                    type: 'message',
                    message: message,
                    timestamp: timestamp,
                    messageId: messageId
                });
            } else {
                // Save as offline message
                saveOfflineMessage(currentChatId, message, timestamp, messageId);
                showNotification('Message saved. Will send when friend is online.', 'info');
            }
        }
        
        // Save message to local storage
        function saveMessage(contactId, message, isOutgoing, timestamp, messageId) {
            const key = `freechat_messages_${contactId}`;
            const messages = JSON.parse(localStorage.getItem(key) || '[]');
            
            messages.push({
                id: messageId || Date.now().toString(),
                text: message,
                outgoing: isOutgoing,
                timestamp: timestamp,
                delivered: isOutgoing ? false : true
            });
            
            localStorage.setItem(key, JSON.stringify(messages));
        }
        
        // Render chat messages
        function renderChatMessages(contactId) {
            const container = document.getElementById('messagesContainer');
            const key = `freechat_messages_${contactId}`;
            const messages = JSON.parse(localStorage.getItem(key) || '[]');
            
            container.innerHTML = '';
            
            messages.forEach(msg => {
                const msgDiv = document.createElement('div');
                msgDiv.className = `message ${msg.outgoing ? 'outgoing' : 'incoming'}`;
                
                const time = new Date(msg.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                const status = msg.outgoing ? (msg.delivered ? '‚úì‚úì' : '‚úì') : '';
                
                msgDiv.innerHTML = `
                    <div>${msg.text}</div>
                    <div class="message-time">${time} ${status}</div>
                `;
                
                container.appendChild(msgDiv);
            });
            
            container.scrollTop = container.scrollHeight;
        }
        
        // Render single message
        function renderMessage(contactId, message, isOutgoing, timestamp, messageId) {
            const container = document.getElementById('messagesContainer');
            
            const msgDiv = document.createElement('div');
            msgDiv.className = `message ${isOutgoing ? 'outgoing' : 'incoming'}`;
            
            const time = new Date(timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            const status = isOutgoing ? '‚úì' : '';
            
            msgDiv.innerHTML = `
                <div>${message}</div>
                <div class="message-time">${time} ${status}</div>
            `;
            
            container.appendChild(msgDiv);
            container.scrollTop = container.scrollHeight;
        }
        
        // Load contacts from local storage
        function loadContacts() {
            // This would normally load from server
            // For now, we'll use localStorage
            return JSON.parse(localStorage.getItem('freechat_contacts') || '[]');
        }
        
        // Render contacts list
        function renderContacts() {
            const contacts = loadContacts();
            const container = document.getElementById('contactsList');
            
            if (contacts.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px 20px; color: #666;">
                        <div style="font-size: 48px; margin-bottom: 20px;">üë•</div>
                        <p>No contacts yet</p>
                        <p style="font-size: 13px; margin-top: 10px;">Add friends using their ID to start chatting</p>
                        <button class="btn" onclick="showPage('qrPage')" style="margin-top: 20px;">Add Contact</button>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = contacts.map(contactId => `
                <div class="contact-item" onclick="startChat('${contactId}')">
                    <div class="contact-avatar">${contactId.charAt(0)}</div>
                    <div class="contact-info">
                        <h4>${contactId}</h4>
                        <p>${connections[contactId] ? 'Online' : 'Offline'}</p>
                    </div>
                    <div class="online-indicator" style="background: ${connections[contactId] ? '#4CD964' : '#FF3B30'}"></div>
                </div>
            `).join('');
        }
        
        // Video Call Functions
        async function startVideoCall() {
            if (!currentChatId || !connections[currentChatId]) {
                showNotification('Friend must be online for video call', 'error');
                return;
            }
            
            try {
                mediaStream = await navigator.mediaDevices.getUserMedia({
                    video: true,
                    audio: true
                });
                
                document.getElementById('localVideo').srcObject = mediaStream;
                showPage('callPage');
                
                const call = peer.call(currentChatId, mediaStream);
                handleCall(call, true);
                
            } catch (err) {
                console.error('Error accessing media devices:', err);
                showNotification('Cannot access camera/microphone', 'error');
            }
        }
        
        function startNewCall() {
            showNotification('Enter friend ID to start call', 'info');
            showPage('qrPage');
        }
        
        function handleIncomingCall(call) {
            if (confirm(`Incoming video call from ${call.peer}. Accept?`)) {
                navigator.mediaDevices.getUserMedia({
                    video: true,
                    audio: true
                }).then(stream => {
                    mediaStream = stream;
                    document.getElementById('localVideo').srcObject = stream;
                    showPage('callPage');
                    
                    call.answer(stream);
                    handleCall(call, false);
                }).catch(err => {
                    console.error('Error accessing media devices:', err);
                    showNotification('Cannot access camera/microphone', 'error');
                });
            } else {
                call.close();
            }
        }
        
        function handleCall(call, isOutgoing) {
            call.on('stream', (remoteStream) => {
                document.getElementById('remoteVideo').srcObject = remoteStream;
                startCallTimer();
                showNotification('Call connected!', 'success');
            });
            
            call.on('close', () => {
                endCall();
            });
            
            call.on('error', (err) => {
                console.error('Call error:', err);
                showNotification('Call failed', 'error');
                endCall();
            });
            
            currentConnection = call;
        }
        
        function endCall() {
            if (currentConnection) {
                currentConnection.close();
                currentConnection = null;
            }
            
            if (mediaStream) {
                mediaStream.getTracks().forEach(track => track.stop());
                mediaStream = null;
            }
            
            stopCallTimer();
            showPage('contactsPage');
        }
        
        function toggleMute() {
            if (mediaStream) {
                const audioTrack = mediaStream.getAudioTracks()[0];
                if (audioTrack) {
                    audioTrack.enabled = !audioTrack.enabled;
                    document.getElementById('muteBtn').textContent = audioTrack.enabled ? 'üîá' : 'üîà';
                }
            }
        }
        
        function toggleVideo() {
            if (mediaStream) {
                const videoTrack = mediaStream.getVideoTracks()[0];
                if (videoTrack) {
                    videoTrack.enabled = !videoTrack.enabled;
                    document.getElementById('videoBtn').textContent = videoTrack.enabled ? 'üìπ' : 'üì∑';
                }
            }
        }
        
        function startCallTimer() {
            callStartTime = new Date();
            callTimerInterval = setInterval(updateCallTimer, 1000);
        }
        
        function stopCallTimer() {
            if (callTimerInterval) {
                clearInterval(callTimerInterval);
                callTimerInterval = null;
            }
        }
        
        function updateCallTimer() {
            if (!callStartTime) return;
            
            const now = new Date();
            const diff = Math.floor((now - callStartTime) / 1000);
            const minutes = Math.floor(diff / 60).toString().padStart(2, '0');
            const seconds = (diff % 60).toString().padStart(2, '0');
            
            document.getElementById('callTimer').textContent = `${minutes}:${seconds}`;
        }
        
        // Offline messaging
        function saveOfflineMessage(contactId, message, timestamp, messageId) {
            const key = `freechat_offline_${contactId}`;
            const messages = JSON.parse(localStorage.getItem(key) || '[]');
            
            messages.push({
                messageId: messageId,
                message: message,
                timestamp: timestamp
            });
            
            localStorage.setItem(key, JSON.stringify(messages));
        }
        
        function loadOfflineMessages() {
            // Load offline messages from localStorage
            const contacts = loadContacts();
            contacts.forEach(contactId => {
                const key = `freechat_offline_${contactId}`;
                offlineMessages[contactId] = JSON.parse(localStorage.getItem(key) || '[]');
            });
        }
        
        function sendPendingOfflineMessages(contactId) {
            const key = `freechat_offline_${contactId}`;
            const messages = JSON.parse(localStorage.getItem(key) || '[]');
            
            if (messages.length > 0 && connections[contactId]) {
                messages.forEach(msg => {
                    connections[contactId].send({
                        type: 'message',
                        message: msg.message,
                        timestamp: msg.timestamp,
                        messageId: msg.messageId
                    });
                });
                
                // Clear offline messages
                localStorage.removeItem(key);
                delete offlineMessages[contactId];
            }
        }
        
        function markMessageDelivered(messageId) {
            // Find and mark message as delivered
            const contacts = loadContacts();
            contacts.forEach(contactId => {
                const key = `freechat_messages_${contactId}`;
                const messages = JSON.parse(localStorage.getItem(key) || '[]');
                
                const updatedMessages = messages.map(msg => {
                    if (msg.id === messageId) {
                        msg.delivered = true;
                    }
                    return msg;
                });
                
                localStorage.setItem(key, JSON.stringify(updatedMessages));
            });
        }
        
        // Show typing indicator
        function showTypingIndicator(contactId, isTyping) {
            if (currentChatId === contactId) {
                const container = document.getElementById('messagesContainer');
                let typingIndicator = container.querySelector('.typing-indicator');
                
                if (isTyping && !typingIndicator) {
                    typingIndicator = document.createElement('div');
                    typingIndicator.className = 'typing-indicator';
                    typingIndicator.innerHTML = `
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    `;
                    container.appendChild(typingIndicator);
                    container.scrollTop = container.scrollHeight;
                } else if (!isTyping && typingIndicator) {
                    typingIndicator.remove();
                }
            }
        }
        
        // Initialize the app
        window.onload = function() {
            initPeer();
            
            // Add keyboard shortcut for sending message
            document.getElementById('messageInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
            
            // Show typing indicator
            document.getElementById('messageInput').addEventListener('input', function() {
                if (currentChatId && connections[currentChatId]) {
                    connections[currentChatId].send({
                        type: 'typing',
                        isTyping: true
                    });
                    
                    // Clear typing indicator after delay
                    clearTimeout(window.typingTimeout);
                    window.typingTimeout = setTimeout(() => {
                        if (connections[currentChatId]) {
                            connections[currentChatId].send({
                                type: 'typing',
                                isTyping: false
                            });
                        }
                    }, 1000);
                }
            });
            
            // Demo data for testing
            setTimeout(() => {
                if (loadContacts().length === 0) {
                    // Add some demo contacts
                    const demoContacts = ['CoolTiger1234', 'HappyPanda5678', 'SmartEagle9012'];
                    localStorage.setItem('freechat_contacts', JSON.stringify(demoContacts));
                    renderContacts();
                }
            }, 1000);
        };
    </script>
</body>
</html>
